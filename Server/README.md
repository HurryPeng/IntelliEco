## 服务端部署

### 概述

智慧生态项目的服务端（下称“服务端”）基于Windows Server，使用FTP协议实现json文件的传输，配合以相关程序对json文件进行的分析，实现对客户端请求的识别、处理和回应。

服务端包括以下模块：

1. FTP模块

2. 请求识别与处理模块

3. 记录模块

### 部署

#### 文件结构

本项目的文件结构如下：

- 根目录（手动创建，路径不允许包括空格）
  
  - 请求识别与处理模块（手动部署）
  
  - users.json（保存个人用户信息）
  
  - buffer文件夹（自动生成）
    
    - 多个以请求的uuid命名的文件夹，文件夹下临时存放具体的请求文件（自动生成）
  
  - record文件夹（自动生成）
    
    - 多对记录文件，每一对包括两个文件名相同的jpg和json文件（自动生成）

每一部分的部署将在下文中具体介绍。

#### FTP模块

本项目的FTP模块可以通过Windows Server原生的FTP功能实现，也可以使用其他FTP工具实现。无论使用哪一种方式，都需要将FTP设为被动模式，并开放一定数量的端口供文件传输使用。FTP的用户只需设定一个，不限制登陆数量，并允许其拥有buffer文件夹的读写权限。该用户应与Android客户端内硬编码的FTP用户一致。注意！该FTP用户可以看作任意一个客户端与服务端联系的通用通行证，与users.json内记录的个人用户并非同一个概念，且不存在联系。

#### 请求识别与处理模块

该模块包括以下程序/动态链接库文件，需要在编译后复制到根目录下：

- RequestScan.py

- RequestProcess.exe

- MothCount.exe

- concrt140.dll

- libgcc_s_seh-1.dll

- libstdc++-6.dll

- libwinpthread-1.dll

- msvcp140.dll

- opencv_world410.dll

- vcruntime140.dll

##### 请求识别模块（RequestScan.py）

该脚本是服务端的入口程序，会不间断地扫描buffer文件夹内出现的新请求，将请求传递给RequestProcess.exe进行进一步处理。处理完成后，该脚本会自动清理buffer内残留的临时文件。

另外，该脚本以Python3编写，如果服务器不存在Python3运行环境，则需要提前安装。具体参见Python官网。

##### 请求处理模块（RequestProcess.exe）

收到请求后，该程序会对请求进行分类处理。所有请求可分为下列三类：

- login（登陆请求）

- upload（上传请求）

- refresh（查看记录请求）

对于每一类请求，该程序都会读取请求信息并生成回应文件，等待客户端下载。其中upload请求涉及图像分析，该程序会进一步调用MothCount.exe获取结果，将结果保存进回应文件返回给客户端并在record内保留记录。

#### 记录模块

记录模块包括个人用户记录users.json和数据记录record文件夹。

users.json内记录了所有个人用户的用户名、密码和权限。目前，各种权限之间没有差异。可以通过后台登陆服务器并参照已有的记录修改users.json中的内容来完成用户的注册和注销等操作。

record文件夹记录所有用户上传的监测数据，不需要手动创建，服务端开始运行后会自动生成。每一个upload请求都会在record文件夹中留下两个文件名相同（文件名包括上传用户和上传时间）的jpg和json文件。其中jpg文件是用户上传的原始监测数据，json文件中则记录了该数据的上传用户、时间、经纬度和MothCount.exe对该数据的分析结果。Android客户端的refresh请求只能获取json文件中的信息，若需要查看原始监测数据图片，则需要通过后台登陆服务器。

### 运行与停止

部署完成后，执行RequestScan.py即可让服务端开始运行。运行中的任何时候，使用Ctrl + C终止RequestScan.py的运行窗口即可停止服务端。
